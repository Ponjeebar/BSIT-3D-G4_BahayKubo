<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Edit Profile - BAHAY KUBO Resort</title>
    <link rel="icon" type="image/png" href="logo/logo.png">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

    <link rel="stylesheet" href="css/open-iconic-bootstrap.min.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/style.css">
    
    <style>
      * {
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Nunito Sans', sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
        padding: 0;
        margin: 0;
      }
      
      .profile-container {
        min-height: 100vh;
        padding: 80px 20px 50px;
        background: #f8f9fa;
      }
      
      .profile-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 30px;
      }
      
      @media (max-width: 968px) {
        .profile-wrapper {
          grid-template-columns: 1fr;
        }
      }
      
      /* Profile Sidebar */
      .profile-sidebar {
        background: #fff;
        border-radius: 20px;
        padding: 40px 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        height: fit-content;
        position: sticky;
        top: 100px;
      }
      
      .profile-avatar-wrapper {
        position: relative;
        display: inline-block;
        margin: 0 auto 20px;
        cursor: pointer;
      }
      
      .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: #21cc7a;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        color: #fff;
        font-weight: 700;
        text-transform: uppercase;
        box-shadow: 0 10px 30px rgba(33, 204, 122, 0.3);
        position: relative;
        overflow: hidden;
        border: 4px solid #fff;
        transition: all 0.3s;
      }
      
      .profile-avatar:hover {
        transform: scale(1.05);
        box-shadow: 0 15px 40px rgba(33, 204, 122, 0.4);
      }
      
      .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
      }
      
      .profile-avatar-upload {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 40px;
        height: 40px;
        background: #21cc7a;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 18px;
        border: 3px solid #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: all 0.3s;
      }
      
      .profile-avatar-wrapper:hover .profile-avatar-upload {
        background: #1ba865;
        transform: scale(1.1);
      }
      
      .profile-avatar-upload input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }
      
      .profile-name {
        text-align: center;
        margin-bottom: 10px;
      }
      
      .profile-name h3 {
        color: #333;
        font-size: 24px;
        font-weight: 700;
        margin: 0;
      }
      
      .profile-username {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-bottom: 30px;
      }
      
      .profile-stats {
        border-top: 1px solid #e9ecef;
        padding-top: 20px;
        margin-top: 20px;
      }
      
      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
      }
      
      .stat-item:last-child {
        border-bottom: none;
      }
      
      .stat-label {
        color: #666;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .stat-label i {
        color: #21cc7a;
        width: 20px;
      }
      
      .stat-value {
        color: #333;
        font-weight: 600;
        font-size: 14px;
      }
      
      .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #21cc7a;
        text-decoration: none;
        font-weight: 600;
        margin-top: 20px;
        transition: all 0.3s;
      }
      
      .back-btn:hover {
        color: #1ba865;
        transform: translateX(-5px);
      }
      
      /* Main Profile Card */
      .profile-card {
        background: #fff;
        border-radius: 20px;
        padding: 50px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      }
      
      .profile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
      }
      
      .profile-header h2 {
        color: #333;
        font-size: 32px;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .profile-header h2 i {
        color: #21cc7a;
        font-size: 28px;
      }
      
      .section-title {
        color: #333;
        font-size: 20px;
        font-weight: 700;
        margin: 30px 0 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .section-title i {
        color: #21cc7a;
      }
      
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }
      
      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }
      
      .form-group {
        margin-bottom: 25px;
      }
      
      .form-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        color: #333;
        font-weight: 600;
        font-size: 14px;
      }
      
      .form-group label i {
        color: #21cc7a;
        width: 18px;
      }
      
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 15px;
        font-family: 'Nunito Sans', sans-serif;
        transition: all 0.3s;
        background: #f8f9fa;
      }
      
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #21cc7a;
        background: #fff;
        box-shadow: 0 0 0 4px rgba(33, 204, 122, 0.1);
      }
      
      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }
      
      .form-group small {
        display: block;
        margin-top: 6px;
        color: #666;
        font-size: 12px;
      }
      
      .password-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        margin-top: 30px;
        border: 2px dashed #e9ecef;
      }
      
      .btn-group {
        display: flex;
        gap: 15px;
        margin-top: 40px;
        padding-top: 30px;
        border-top: 2px solid #f0f0f0;
      }
      
      .btn-submit {
        flex: 1;
        background: #21cc7a;
        color: #fff;
        padding: 16px 30px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(33, 204, 122, 0.3);
      }
      
      .btn-submit:hover {
        background: #1ba865;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(33, 204, 122, 0.4);
      }
      
      .btn-submit:active {
        transform: translateY(0);
      }
      
      .btn-cancel {
        padding: 16px 30px;
        background: #6c757d;
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
      }
      
      .btn-cancel:hover {
        background: #5a6268;
        color: #fff;
        text-decoration: none;
        transform: translateY(-2px);
      }
      
      .alert {
        padding: 18px 20px;
        margin-bottom: 30px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        animation: slideDown 0.3s ease;
      }
      
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
      }
      
      .alert-success i {
        color: #28a745;
        font-size: 20px;
      }
      
      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
      }
      
      .alert-error i {
        color: #dc3545;
        font-size: 20px;
      }
      
      .info-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #e7f3ff;
        color: #0066cc;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 8px;
      }
      
      .info-badge i {
        font-size: 10px;
      }
      
      /* Payment Settings Styles */
      .btn-payment-toggle {
        width: 100%;
        background: #21cc7a;
        color: #fff;
        padding: 16px 24px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 4px 15px rgba(33, 204, 122, 0.3);
      }
      
      .btn-payment-toggle:hover {
        background: #1ba865;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(33, 204, 122, 0.4);
      }
      
      .btn-payment-toggle i:first-child {
        margin-right: 10px;
      }
      
      .btn-payment-toggle i:last-child {
        transition: transform 0.3s;
      }
      
      .btn-payment-toggle.active i:last-child {
        transform: rotate(180deg);
      }
      
      .payment-section {
        background: #f8f9fa;
        padding: 25px;
        border-radius: 12px;
        margin-top: 20px;
        border: 2px solid #e9ecef;
        animation: slideDown 0.3s ease;
      }
      
      .payment-method-card {
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        margin-bottom: 20px;
      }
      
      .payment-card-header {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }
      
      .payment-card-header i {
        color: #21cc7a;
        font-size: 20px;
      }
      
      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-weight: 500;
        color: #333;
      }
      
      .checkbox-label input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #21cc7a;
      }
      
      .form-control {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 15px;
        font-family: 'Nunito Sans', sans-serif;
        transition: all 0.3s;
        background: #f8f9fa;
      }
      
      .form-control:focus {
        outline: none;
        border-color: #21cc7a;
        background: #fff;
        box-shadow: 0 0 0 4px rgba(33, 204, 122, 0.1);
      }
      
      /* Hide navigation menu items */
      #ftco-navbar .navbar-nav .nav-item:not(.dropdown) {
        display: none !important;
      }
      #ftco-navbar .navbar-toggler {
        display: none !important;
      }
      
      /* Cropper Modal */
      .crop-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        animation: fadeIn 0.3s;
      }
      
      .crop-modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .crop-modal-content {
        background: #fff;
        border-radius: 20px;
        padding: 30px;
        max-width: 90%;
        max-height: 90vh;
        width: 600px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.3s;
      }
      
      @keyframes slideDown {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      .crop-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }
      
      .crop-modal-header h3 {
        margin: 0;
        color: #333;
        font-size: 24px;
        font-weight: 700;
      }
      
      .crop-modal-close {
        background: none;
        border: none;
        font-size: 28px;
        color: #999;
        cursor: pointer;
        padding: 0;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s;
      }
      
      .crop-modal-close:hover {
        background: #f0f0f0;
        color: #333;
      }
      
      .crop-container {
        width: 100%;
        max-height: 400px;
        margin-bottom: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        overflow: hidden;
      }
      
      .crop-container img {
        max-width: 100%;
        display: block;
      }
      
      .crop-modal-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
      }
      
      .btn-crop {
        padding: 12px 30px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .btn-crop-cancel {
        background: #f0f0f0;
        color: #666;
      }
      
      .btn-crop-cancel:hover {
        background: #e0e0e0;
      }
      
      .btn-crop-save {
        background: #21cc7a;
        color: #fff;
      }
      
      .btn-crop-save:hover {
        background: #1ba865;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(33, 204, 122, 0.3);
      }
      
      .btn-crop-save:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }
    </style>
  </head>
  <body>

    <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
	    <div class="container">
	      <a class="navbar-brand" href="index.html">BAHAY <span>KUBO</span></a>
	    </div>
	  </nav>

    <div class="profile-container">
      <div class="profile-wrapper">
        <!-- Profile Sidebar -->
        <div class="profile-sidebar">
          <div class="profile-avatar-wrapper">
            <div class="profile-avatar" id="profileAvatar">
              <span id="avatarInitials">GU</span>
            </div>
            <div class="profile-avatar-upload">
              <i class="fas fa-camera"></i>
              <input type="file" id="avatarUpload" name="avatar" accept="image/*">
            </div>
          </div>
          <div class="profile-name">
            <h3>Guest User</h3>
          </div>
          <div class="profile-username">
            <i class="fas fa-user"></i> @guest
          </div>
          
          <div class="profile-stats">
            <div class="stat-item">
              <span class="stat-label">
                <i class="fas fa-calendar-alt"></i>
                Member Since
              </span>
              <span class="stat-value">Today</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">
                <i class="fas fa-shield-alt"></i>
                Account Status
              </span>
              <span class="stat-value" style="color: #28a745;">
                <i class="fas fa-check-circle"></i> Active
              </span>
            </div>
            <div class="stat-item">
              <span class="stat-label">
                <i class="fas fa-key"></i>
                Security
              </span>
              <span class="stat-value" style="color: #28a745;">
                <i class="fas fa-lock"></i> Protected
              </span>
            </div>
          </div>
          
          <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i>
            Back to Home
          </a>
        </div>

        <!-- Main Profile Form -->
        <div class="profile-card">
          <div class="profile-header">
            <h2>
              <i class="fas fa-user-edit"></i>
              Edit Profile
            </h2>
          </div>
          
          <div id="alertMessage" style="display: none;"></div>

          <form method="POST" action="#" id="profileForm" enctype="multipart/form-data">
            <div class="section-title">
              <i class="fas fa-id-card"></i>
              Personal Information
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">
                  <i class="fas fa-user"></i>
                  First Name
                </label>
                <input type="text" id="firstName" name="firstName" value="Guest" required>
              </div>
              
              <div class="form-group">
                <label for="lastName">
                  <i class="fas fa-user"></i>
                  Last Name
                </label>
                <input type="text" id="lastName" name="lastName" value="User" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="username">
                <i class="fas fa-at"></i>
                Username
                <span class="info-badge">
                  <i class="fas fa-info-circle"></i>
                  Unique
                </span>
              </label>
              <input type="text" id="username" name="username" value="guest" required>
              <small>Your username is used for login and must be unique.</small>
            </div>
            
            <div class="section-title">
              <i class="fas fa-lock"></i>
              Security Settings
            </div>
            
            <div class="password-section">
              <div class="form-group">
                <label for="password">
                  <i class="fas fa-key"></i>
                  New Password
                </label>
                <input type="password" id="password" name="password" placeholder="Enter new password (leave blank to keep current)">
                <small>
                  <i class="fas fa-shield-alt"></i>
                  Password must be at least 6 characters long. Leave blank if you don't want to change it.
                </small>
              </div>
              
              <div class="form-group">
                <label for="confirmPassword">
                  <i class="fas fa-key"></i>
                  Confirm New Password
                </label>
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password">
              </div>
            </div>
            
            <div class="section-title">
              <i class="fas fa-credit-card"></i>
              Payment Settings
            </div>
            
            <div style="margin-bottom: 20px;">
              <button type="button" id="togglePaymentBtn" class="btn-payment-toggle">
                <i class="fas fa-credit-card"></i>
                Manage Payment Settings
                <i class="fas fa-chevron-down" id="paymentToggleIcon"></i>
              </button>
            </div>
            
            <div class="payment-section" id="paymentSection" style="display: none;">
              <div class="form-group">
                <label for="defaultPaymentMethod">
                  <i class="fas fa-wallet"></i>
                  Default Payment Method
                </label>
                <select id="defaultPaymentMethod" name="defaultPaymentMethod" class="form-control">
                  <option value="credit_card" selected>Credit/Debit Card</option>
                  <option value="paypal">PayPal</option>
                  <option value="bank_transfer">Bank Transfer</option>
                  <option value="cash">Cash on Arrival</option>
                </select>
                <small>This will be used as your default payment method for bookings.</small>
              </div>
              
              <div class="payment-method-card" id="creditCardSection">
                <div class="payment-card-header">
                  <i class="fas fa-credit-card"></i>
                  <span>Credit/Debit Card</span>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="cardNumber">
                      <i class="fas fa-hashtag"></i>
                      Card Number
                    </label>
                    <input type="text" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                  </div>
                  <div class="form-group">
                    <label for="cardHolder">
                      <i class="fas fa-user"></i>
                      Card Holder Name
                    </label>
                    <input type="text" id="cardHolder" name="cardHolder" placeholder="Guest User">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="cardExpiry">
                      <i class="fas fa-calendar"></i>
                      Expiry Date
                    </label>
                    <input type="text" id="cardExpiry" name="cardExpiry" placeholder="MM/YY" maxlength="5">
                  </div>
                  <div class="form-group">
                    <label for="cardCVV">
                      <i class="fas fa-lock"></i>
                      CVV
                    </label>
                    <input type="text" id="cardCVV" name="cardCVV" placeholder="123" maxlength="4">
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="billingAddress">
                  <i class="fas fa-map-marker-alt"></i>
                  Billing Address
                </label>
                <textarea id="billingAddress" name="billingAddress" placeholder="Enter your billing address" rows="3"></textarea>
              </div>
              
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="savePaymentInfo" name="savePaymentInfo" checked>
                  <span>Save payment information for faster checkout</span>
                </label>
              </div>
              
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="autoPay" name="autoPay">
                  <span>Enable automatic payments for recurring bookings</span>
                </label>
              </div>
            </div>
            
            <div class="btn-group">
              <button type="submit" class="btn-submit">
                <i class="fas fa-save"></i>
                Save Changes
              </button>
              <a href="index.html" class="btn-cancel">
                <i class="fas fa-times"></i>
                Cancel
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Image Cropper Modal -->
    <div id="cropModal" class="crop-modal">
      <div class="crop-modal-content">
        <div class="crop-modal-header">
          <h3><i class="fas fa-crop"></i> Crop Your Photo</h3>
          <button type="button" class="crop-modal-close" id="closeCropModal">&times;</button>
        </div>
        <div class="crop-container">
          <img id="cropImage" src="" alt="Crop Image">
        </div>
        <div class="crop-modal-actions">
          <button type="button" class="btn-crop btn-crop-cancel" id="cancelCrop">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="button" class="btn-crop btn-crop-save" id="saveCrop">
            <i class="fas fa-check"></i> Save Photo
          </button>
        </div>
      </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-migrate-3.0.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/jquery.stellar.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.magnific-popup.min.js"></script>
    <script src="js/aos.js"></script>
    <script src="js/jquery.animateNumber.min.js"></script>
    <script src="js/bootstrap-datepicker.js"></script>
    <script src="js/scrollax.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="js/main.js"></script>
    <script>
      // Load and display user data
      function loadUserData() {
        // Get current user from localStorage or sessionStorage
        var currentUser = null;
        var storedUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
        
        if (!storedUser) {
          // No user logged in, redirect to login
          window.location.href = 'login.html';
          return;
        }
        
        try {
          currentUser = JSON.parse(storedUser);
        } catch (e) {
          console.error('Error parsing user data:', e);
          window.location.href = 'login.html';
          return;
        }
        
        // Get users array to find full user data
        var users = JSON.parse(localStorage.getItem('users') || '[]');
        var user = users.find(u => u.id === currentUser.user_id);
        
        if (!user) {
          window.location.href = 'login.html';
          return;
        }
        
        // Populate form fields
        document.getElementById('firstName').value = user.firstName || currentUser.first_name || '';
        document.getElementById('lastName').value = user.lastName || currentUser.last_name || '';
        document.getElementById('username').value = user.username || currentUser.username || '';
        
        // Update sidebar
        var fullName = (user.firstName || '') + ' ' + (user.lastName || '');
        fullName = fullName.trim() || user.username || 'User';
        document.querySelector('.profile-name h3').textContent = fullName;
        document.querySelector('.profile-username').innerHTML = '<i class="fas fa-user"></i> @' + user.username;
        
        // Update initials
        var initials = '';
        if (user.firstName && user.lastName) {
          initials = (user.firstName.charAt(0) + user.lastName.charAt(0)).toUpperCase();
        } else if (user.username) {
          initials = user.username.substring(0, 2).toUpperCase();
        } else {
          initials = 'GU';
        }
        document.getElementById('avatarInitials').textContent = initials;
        
        // Load avatar if exists
        if (user.avatar) {
          var avatarImg = document.getElementById('avatarImage');
          if (avatarImg) {
            avatarImg.src = user.avatar;
            document.getElementById('avatarInitials').style.display = 'none';
          } else {
            document.getElementById('avatarInitials').style.display = 'none';
            var img = document.createElement('img');
            img.src = user.avatar;
            img.alt = 'Profile Picture';
            img.id = 'avatarImage';
            document.getElementById('profileAvatar').appendChild(img);
          }
        }
        
        // Load member since date
        if (user.createdAt) {
          var createdDate = new Date(user.createdAt);
          var options = { year: 'numeric', month: 'long', day: 'numeric' };
          document.querySelector('.stat-item .stat-value').textContent = createdDate.toLocaleDateString('en-US', options);
        }
        
        // Store current user data for form submission
        window.currentUserData = {
          currentUser: currentUser,
          user: user,
          users: users
        };
      }
      
      // Show alert message
      function showAlert(message, type) {
        var alertDiv = document.getElementById('alertMessage');
        alertDiv.className = 'alert alert-' + (type || 'success');
        alertDiv.innerHTML = '<i class="fas fa-' + (type === 'error' ? 'exclamation-circle' : 'check-circle') + '"></i> ' + message;
        alertDiv.style.display = 'block';
        
        setTimeout(function() {
          alertDiv.style.display = 'none';
        }, 5000);
      }
      
      // Load user data on page load
      loadUserData();
      
      // Password confirmation validation
      document.getElementById('profileForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var password = document.getElementById('password').value;
        var confirmPassword = document.getElementById('confirmPassword').value;
        
        if (password && password !== confirmPassword) {
          showAlert('Passwords do not match! Please try again.', 'error');
          document.getElementById('confirmPassword').focus();
          return false;
        }
        
        if (password && password.length < 6) {
          showAlert('Password must be at least 6 characters long.', 'error');
          document.getElementById('password').focus();
          return false;
        }
        
        // Get form values
        var firstName = document.getElementById('firstName').value.trim();
        var lastName = document.getElementById('lastName').value.trim();
        var username = document.getElementById('username').value.trim();
        
        if (!firstName || !lastName || !username) {
          showAlert('Please fill in all required fields.', 'error');
          return false;
        }
        
        // Check if username is already taken by another user
        var users = window.currentUserData.users;
        var currentUserId = window.currentUserData.user.id;
        var usernameExists = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.id !== currentUserId);
        
        if (usernameExists) {
          showAlert('Username already exists. Please choose another.', 'error');
          document.getElementById('username').focus();
          return false;
        }
        
        // Update user data
        var user = window.currentUserData.user;
        user.firstName = firstName;
        user.lastName = lastName;
        user.username = username;
        
        // Update password if provided
        if (password) {
          user.password = password;
        }
        
        // Update users array
        var userIndex = users.findIndex(u => u.id === user.id);
        if (userIndex !== -1) {
          users[userIndex] = user;
          localStorage.setItem('users', JSON.stringify(users));
        }
        
        // Update currentUser session
        var currentUser = window.currentUserData.currentUser;
        currentUser.first_name = firstName;
        currentUser.last_name = lastName;
        currentUser.username = username;
        
        // Save to appropriate storage
        if (localStorage.getItem('currentUser')) {
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
        } else {
          sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
        
        // Update window object
        window.currentUserData.user = user;
        window.currentUserData.currentUser = currentUser;
        window.currentUserData.users = users;
        
        // Update sidebar
        var fullName = firstName + ' ' + lastName;
        document.querySelector('.profile-name h3').textContent = fullName;
        document.querySelector('.profile-username').innerHTML = '<i class="fas fa-user"></i> @' + username;
        
        // Update initials
        var initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
        document.getElementById('avatarInitials').textContent = initials;
        
        showAlert('Profile updated successfully!', 'success');
        
        // Clear password fields
        document.getElementById('password').value = '';
        document.getElementById('confirmPassword').value = '';
        
        return false;
      });
      
      // Real-time password match indicator
      document.getElementById('confirmPassword').addEventListener('input', function() {
        var password = document.getElementById('password').value;
        var confirmPassword = this.value;
        
        if (password && confirmPassword) {
          if (password === confirmPassword) {
            this.style.borderColor = '#28a745';
          } else {
            this.style.borderColor = '#dc3545';
          }
        } else {
          this.style.borderColor = '#e9ecef';
        }
      });
      
      // Payment method selection handler
      document.getElementById('defaultPaymentMethod').addEventListener('change', function() {
        var selectedMethod = this.value;
        var creditCardSection = document.getElementById('creditCardSection');
        
        if (selectedMethod === 'credit_card') {
          creditCardSection.style.display = 'block';
        } else {
          creditCardSection.style.display = 'none';
        }
      });
      
      // Format card number input
      document.getElementById('cardNumber').addEventListener('input', function(e) {
        var value = e.target.value.replace(/\s/g, '');
        var formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
      });
      
      // Format expiry date input
      document.getElementById('cardExpiry').addEventListener('input', function(e) {
        var value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
      });
      
      // Format CVV (numbers only)
      document.getElementById('cardCVV').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });
      
      // Toggle payment settings section
      document.getElementById('togglePaymentBtn').addEventListener('click', function() {
        var paymentSection = document.getElementById('paymentSection');
        var toggleIcon = document.getElementById('paymentToggleIcon');
        var isVisible = paymentSection.style.display !== 'none';
        
        if (isVisible) {
          paymentSection.style.display = 'none';
          this.classList.remove('active');
        } else {
          paymentSection.style.display = 'block';
          this.classList.add('active');
        }
      });
      
      // Avatar upload functionality
      var avatarUpload = document.getElementById('avatarUpload');
      var avatarWrapper = document.querySelector('.profile-avatar-wrapper');
      var avatarImage = document.getElementById('avatarImage');
      var avatarInitials = document.getElementById('avatarInitials');
      
      // Click on avatar wrapper to trigger file input
      avatarWrapper.addEventListener('click', function(e) {
        if (e.target !== avatarUpload) {
          avatarUpload.click();
        }
      });
      
      // Cropper instance
      var cropper = null;
      var selectedFile = null;
      var cropModal = document.getElementById('cropModal');
      var cropImage = document.getElementById('cropImage');
      var closeCropModal = document.getElementById('closeCropModal');
      var cancelCrop = document.getElementById('cancelCrop');
      var saveCrop = document.getElementById('saveCrop');
      
      // Handle file selection - open crop modal
      avatarUpload.addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (file) {
          // Validate file type
          if (!file.type.match('image.*')) {
            alert('Please select an image file.');
            this.value = ''; // Clear input
            return;
          }
          
          // Validate file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert('Image size should be less than 5MB.');
            this.value = ''; // Clear input
            return;
          }
          
          selectedFile = file;
          
          // Read file and show in crop modal
          var reader = new FileReader();
          reader.onload = function(e) {
            cropImage.src = e.target.result;
            
            // Destroy existing cropper if any
            if (cropper) {
              cropper.destroy();
            }
            
            // Show modal
            cropModal.classList.add('show');
            
            // Initialize cropper with circular aspect ratio
            cropper = new Cropper(cropImage, {
              aspectRatio: 1,
              viewMode: 1,
              dragMode: 'move',
              autoCropArea: 0.8,
              restore: false,
              guides: true,
              center: true,
              highlight: false,
              cropBoxMovable: true,
              cropBoxResizable: true,
              toggleDragModeOnDblclick: false,
              minCropBoxWidth: 100,
              minCropBoxHeight: 100,
            });
          };
          reader.readAsDataURL(file);
        }
      });
      
      // Close modal handlers
      function closeModal() {
        cropModal.classList.remove('show');
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
        cropImage.src = '';
        avatarUpload.value = '';
        selectedFile = null;
      }
      
      closeCropModal.addEventListener('click', closeModal);
      cancelCrop.addEventListener('click', closeModal);
      
      // Close modal when clicking outside
      cropModal.addEventListener('click', function(e) {
        if (e.target === cropModal) {
          closeModal();
        }
      });
      
      // Save cropped image
      saveCrop.addEventListener('click', function() {
        if (!cropper || !selectedFile) {
          return;
        }
        
        // Get cropped canvas
        var canvas = cropper.getCroppedCanvas({
          width: 400,
          height: 400,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
        });
        
        if (!canvas) {
          alert('Failed to crop image. Please try again.');
          return;
        }
        
        // Convert canvas to blob
        canvas.toBlob(function(blob) {
          if (!blob) {
            alert('Failed to process image. Please try again.');
            return;
          }
          
          // Create FormData with cropped image
          var formData = new FormData();
          formData.append('avatar', blob, selectedFile.name);
          formData.append('upload_avatar', '1');
          
          // Show loading
          saveCrop.disabled = true;
          saveCrop.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
          
          // Convert canvas to base64 for localStorage
          var imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
          
          // Save avatar to user data
          if (window.currentUserData && window.currentUserData.user) {
            var user = window.currentUserData.user;
            user.avatar = imageDataUrl;
            
            // Update users array
            var users = window.currentUserData.users;
            var userIndex = users.findIndex(u => u.id === user.id);
            if (userIndex !== -1) {
              users[userIndex] = user;
              localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Update window object
            window.currentUserData.user = user;
            window.currentUserData.users = users;
            
            // Close modal
            closeModal();
            
            // Update avatar display
            var avatarImg = document.getElementById('avatarImage');
            if (avatarImg) {
              avatarImg.src = imageDataUrl;
            } else {
              // Create image element if it doesn't exist
              if (avatarInitials) avatarInitials.style.display = 'none';
              var img = document.createElement('img');
              img.src = imageDataUrl;
              img.alt = 'Profile Picture';
              img.id = 'avatarImage';
              document.getElementById('profileAvatar').appendChild(img);
            }
            
            // Show success message
            showAlert('Profile picture updated successfully!', 'success');
          } else {
            alert('Error: User data not found. Please refresh the page.');
          }
          
          saveCrop.disabled = false;
          saveCrop.innerHTML = '<i class="fas fa-check"></i> Save Photo';
        }, 'image/jpeg', 0.9); // Convert to JPEG with 90% quality
      });
    </script>
    
  </body>
</html>
